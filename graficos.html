<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GrÃ¡ficos de Gastos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 15px;
      text-align: center;
      background: #f4f4f4;
    }

    h1 {
      background: linear-gradient(90deg, #1976d2, #2196f3);
      color: white;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 10px 0;
    }

    .filtros input, .filtros select, .filtros button {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }

    .graficos-container {
      max-width: 700px;
      margin: auto;
    }

    canvas {
      background: white;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    button {
      background: #1976d2;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #0d47a1;
    }

    @media (prefers-color-scheme: dark) {
      body {
        background: #0d1117;
        color: #e6edf3;
      }
      canvas {
        background: #161b22;
      }
      input, select {
        background: #161b22;
        color: #e6edf3;
        border: 1px solid #30363d;
      }
    }
  </style>
</head>
<body>
  <h1>ðŸ“Š GrÃ¡ficos de Gastos e Ingresos</h1>

  <div class="filtros">
    <label>Desde: <input type="date" id="desde"></label>
    <label>Hasta: <input type="date" id="hasta"></label>
    <label>Tipo: 
      <select id="tipoFiltro">
        <option value="todos">Todos</option>
        <option value="ingreso">Ingresos</option>
        <option value="gasto">Gastos</option>
      </select>
    </label>
    <button onclick="filtrarDatos()">Actualizar</button>
    <button onclick="window.location.href='index.html'">Volver</button>
  </div>

  <div class="graficos-container">
    <h3>Por CategorÃ­a</h3>
    <canvas id="graficoCategorias"></canvas>

    <h3>Por Fecha</h3>
    <canvas id="graficoFechas"></canvas>
  </div>

  <script>
    let movimientos = JSON.parse(localStorage.getItem("movimientos")) || [];
    let chartCat, chartFechas;

    function filtrarDatos() {
      const desde = document.getElementById("desde").value;
      const hasta = document.getElementById("hasta").value;
      const tipo = document.getElementById("tipoFiltro").value;

      let filtrados = movimientos.filter(m => {
        const [dia, mes, anio] = m.fecha.split("-");
        const fechaISO = `${anio}-${mes}-${dia}`;
        const f = new Date(fechaISO);

        let dentroRango = true;
        if (desde && f < new Date(desde)) dentroRango = false;
        if (hasta && f > new Date(hasta)) dentroRango = false;

        let tipoOk = tipo === "todos" || m.tipo === tipo;
        return dentroRango && tipoOk;
      });

      actualizarGraficos(filtrados);
    }

    function actualizarGraficos(data) {
      const porCategoria = {};
      const porFecha = {};

      data.forEach(m => {
        const importe = parseFloat(m.importe);
        const cat = m.categoria || "Ingresos";
        porCategoria[cat] = (porCategoria[cat] || 0) + importe;

        porFecha[m.fecha] = (porFecha[m.fecha] || 0) + (m.tipo === "gasto" ? -importe : importe);
      });

      const catLabels = Object.keys(porCategoria);
      const catData = Object.values(porCategoria);

      const fechaLabels = Object.keys(porFecha).sort((a, b) => {
        const [da, ma, aa] = a.split("-");
        const [db, mb, ab] = b.split("-");
        return new Date(`${aa}-${ma}-${da}`) - new Date(`${ab}-${mb}-${db}`);
      });
      const fechaData = fechaLabels.map(f => porFecha[f]);

      if (chartCat) chartCat.destroy();
      if (chartFechas) chartFechas.destroy();

      const ctx1 = document.getElementById("graficoCategorias");
      chartCat = new Chart(ctx1, {
        type: "doughnut",
        data: {
          labels: catLabels,
          datasets: [{
            data: catData,
            backgroundColor: ["#4caf50","#2196f3","#ff9800","#f44336","#9c27b0"]
          }]
        },
        options: {
          plugins: { legend: { position: "bottom" } }
        }
      });

      const ctx2 = document.getElementById("graficoFechas");
      chartFechas = new Chart(ctx2, {
        type: "bar",
        data: {
          labels: fechaLabels,
          datasets: [{
            label: "Saldo diario (â‚¬)",
            data: fechaData,
            backgroundColor: fechaData.map(v => v >= 0 ? "#4caf50" : "#f44336")
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    filtrarDatos();
  </script>
</body>
</html>
