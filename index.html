<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Control de Gastos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="theme-color" content="#1976d2">
  <style>
    :root{
      --accent: #1976d2;
      --bg: #f6f7f9;
      --card: #ffffff;
      --muted: #71777f;
      --verde: #2e944b;
      --rojo: #d32f2f;
      --radius: 12px;
    }

    /* ===== page layout ===== */
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color:#222;
      display:flex;
      justify-content:center;
      padding:1rem;
      min-height:100vh;
    }

    .app{
      width:100%;
      max-width:980px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(12,20,30,0.08);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    header{
      background: linear-gradient(90deg,var(--accent),#2196f3);
      color:white;
      padding:14px 18px;
    }
    header h1{ margin:0; font-size:1.15rem; text-align:center; font-weight:600; }

    main{ display:grid; grid-template-columns: 1fr 360px; gap:18px; padding:18px; }
    /* responsive fallback: single col */
    @media(max-width:900px){
      main{ grid-template-columns: 1fr; padding:14px; }
    }

    /* ===== left column (form + table) ===== */
    .left {
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .card {
      background:var(--card);
      border-radius:10px;
      padding:10px;
      box-shadow: 0 2px 6px rgba(10,20,30,0.03);
    }

    /* form table */
    .form-table, .mov-table { width:100%; border-collapse:collapse; }
    .form-table th, .form-table td, .mov-table th, .mov-table td {
      padding:8px; text-align:center; border-bottom:1px solid #f0f0f0; font-size:0.95rem;
    }
    .form-table thead th, .mov-table thead th { background:#fbfbfb; font-weight:700; color:#444; }
    .form-row input, .form-row select {
      width:100%; padding:7px; border-radius:8px; border:1px solid #e0e0e0; font-size:0.95rem;
    }

    .btn {
      background:var(--accent); color:white; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700;
    }
    .btn:active{ transform:translateY(1px) }

    .mov-table thead th[role="sortable"]{ cursor:pointer; user-select:none; }

    /* row colors */
    tr.ingreso { background: rgba(46,148,75,0.06); }
    tr.gasto { background: rgba(211,47,47,0.06); }

    .importe-col { text-align:right; font-weight:700; }
    .importe-ingreso { color: var(--verde); }
    .importe-gasto { color: var(--rojo); }

    .action-col { width:56px; }

    /* ===== right column (cards and panels) ===== */
    .right { display:flex; flex-direction:column; gap:12px; }

    .summary-cards { display:flex; gap:10px; flex-direction:column; }
    @media(min-width:900px){
      .summary-cards { flex-direction:column; }
    }
    .summary-card { background:var(--card); border-radius:10px; padding:12px; text-align:center; box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
    .summary-card h4{ margin:0; color:var(--muted); font-weight:600; font-size:0.9rem; }
    .summary-card p{ margin:8px 0 0; font-weight:800; font-size:1.15rem; }

    /* charts container - side by side on wide screens */
    .charts-row { display:flex; gap:12px; flex-direction:column; }
    @media(min-width:900px){
      .charts-row { flex-direction:row; }
      .charts-row .chart-card { flex:1; }
    }
    .chart-card { background:var(--card); padding:10px; border-radius:10px; box-shadow: 0 1px 4px rgba(0,0,0,0.04); }

    canvas{ width:100% !important; height:240px !important; border-radius:8px; display:block; }

    /* tabs / navigation bottom */
    .bottom-nav {
      display:flex; gap:6px; justify-content:space-around; padding:10px; border-top:1px solid #eee; background:var(--card);
    }
    .tab-btn { background:none; border:none; cursor:pointer; padding:8px 10px; font-weight:700; color:#444; display:flex; flex-direction:column; align-items:center; gap:4px; }
    .tab-btn.active{ color:var(--accent); }

    /* small helpers */
    .muted{ color:var(--muted); font-size:0.9rem; }
    .center{ text-align:center; }
    .controls { display:flex; gap:8px; margin-top:8px; }

    /* month picker width */
    .small-input{ max-width:220px; }

  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Control de Gastos">
    <header><h1>Control de Gastos</h1></header>

    <main>
      <!-- LEFT: Home (form + table) -->
      <section class="left">
        <div class="card" aria-labelledby="form-title">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div><strong id="form-title">A√±adir movimiento</strong></div>
            <div class="muted">Rellena fecha y importe</div>
          </div>

          <table class="form-table" role="form" aria-label="Formulario de movimiento">
            <thead>
              <tr>
                <th>Fecha</th><th>Tipo</th><th id="categoriaHeader">Categor√≠a</th><th>Importe</th><th>Acci√≥n</th>
              </tr>
            </thead>
            <tbody>
              <tr class="form-row">
                <td><input id="fecha" type="date" /></td>
                <td>
                  <select id="tipo" onchange="toggleCategoria()">
                    <option value="ingreso">Ingreso</option>
                    <option value="gasto">Gasto</option>
                  </select>
                </td>
                <td id="categoriaCell">
                  <select id="categoria">
                    <option>Casa</option>
                    <option>Alimentaci√≥n</option>
                    <option>Ocio</option>
                    <option>Impuestos</option>
                  </select>
                </td>
                <td><input id="importe" type="number" step="0.01" /></td>
                <td><button class="btn" onclick="agregarMovimiento()">‚ûï</button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="card" aria-labelledby="mov-list-title">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div><strong id="mov-list-title">Movimientos</strong></div>
            <div class="muted">Ordena por fecha: haz clic en la cabecera</div>
          </div>

          <table class="mov-table" id="tablaMovimientos" aria-label="Tabla de movimientos">
            <thead>
              <tr>
                <th role="sortable" onclick="toggleOrden()">Fecha ‚¨ç</th>
                <th>Tipo</th>
                <th>Categor√≠a</th>
                <th>Importe</th>
                <th class="action-col">Acci√≥n</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="display:flex; gap:8px; justify-content:center;">
          <button class="btn" onclick="showTab('graficos')">üìä Gr√°ficos</button>
          <button class="btn" onclick="showTab('resumen')">üìÖ Resumen</button>
        </div>
      </section>

      <!-- RIGHT: summary / graphs / resumen panels -->
      <aside class="right">
        <!-- always-visible summary cards -->
        <div class="summary-cards">
          <div class="summary-card">
            <h4>Ingresos</h4>
            <p id="totalIngresos">0.00 ‚Ç¨</p>
          </div>
          <div class="summary-card">
            <h4>Gastos</h4>
            <p id="totalGastos">0.00 ‚Ç¨</p>
          </div>
          <div class="summary-card">
            <h4>Saldo</h4>
            <p id="saldo" class="muted">0.00 ‚Ç¨</p>
          </div>
        </div>

        <!-- GR√ÅFICOS PESTA√ëA -->
        <div id="graficosPanel" style="display:none;">
          <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px;">
            <div style="display:flex; gap:8px; align-items:center;">
              <label class="muted">Mes</label>
              <input id="grafMes" type="month" class="small-input" />
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <label class="muted">Tipo</label>
              <select id="grafTipo" class="small-input">
                <option value="todos">Todos</option>
                <option value="ingreso">Ingresos</option>
                <option value="gasto">Gastos</option>
              </select>
            </div>
          </div>

          <div class="charts-row">
            <div class="chart-card">
              <h4 style="margin:6px 0;">Distribuci√≥n por categor√≠a</h4>
              <canvas id="grafCat"></canvas>
            </div>
            <div class="chart-card">
              <h4 style="margin:6px 0;">Ingresos vs Gastos (mes)</h4>
              <canvas id="grafBar"></canvas>
            </div>
          </div>
        </div>

        <!-- RESUMEN PESTA√ëA -->
        <div id="resumenPanel" style="display:none;">
          <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px;">
            <div style="display:flex; gap:8px; align-items:center;">
              <label class="muted">Mes</label>
              <input id="resMes" type="month" class="small-input" />
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
            <div style="min-width:140px; text-align:center;" class="card">
              <div class="muted">Ingresos</div>
              <div id="res_ing" style="font-weight:800; margin-top:6px;">0.00 ‚Ç¨</div>
            </div>
            <div style="min-width:140px; text-align:center;" class="card">
              <div class="muted">Gastos</div>
              <div id="res_gas" style="font-weight:800; margin-top:6px;">0.00 ‚Ç¨</div>
            </div>
            <div style="min-width:140px; text-align:center;" class="card">
              <div class="muted">Saldo</div>
              <div id="res_saldo" style="font-weight:800; margin-top:6px;">0.00 ‚Ç¨</div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <div style="display:flex; gap:12px;" class="charts-row">
              <div class="chart-card" style="flex:1;">
                <h4 style="margin:6px 0;">Gastos por categor√≠a</h4>
                <canvas id="resDough"></canvas>
              </div>
              <div class="chart-card" style="flex:1;">
                <h4 style="margin:6px 0;">Ingresos vs Gastos (mes)</h4>
                <canvas id="resBar"></canvas>
              </div>
            </div>
          </div>
        </div>

      </aside>
    </main>

    <!-- bottom navigation -->
    <nav class="bottom-nav" role="navigation" aria-label="Navegaci√≥n app">
      <button id="nav-home" class="tab-btn active" onclick="showTab('home')">üè†<small>Inicio</small></button>
      <button id="nav-graphs" class="tab-btn" onclick="showTab('graficos')">üìä<small>Gr√°ficos</small></button>
      <button id="nav-summary" class="tab-btn" onclick="showTab('resumen')">üìÖ<small>Resumen</small></button>
    </nav>
  </div>

<script>
/* ===== IndexedDB setup ===== */
let db;
let movimientos = []; // cached array
let ordenAsc = false;

// open DB
function abrirDB(){
  const req = indexedDB.open('GastosDB_v3', 1);
  req.onupgradeneeded = e => {
    db = e.target.result;
    if(!db.objectStoreNames.contains('movs')){
      const store = db.createObjectStore('movs', { keyPath:'id', autoIncrement:true });
      store.createIndex('fecha','fecha',{unique:false});
    }
  };
  req.onsuccess = e => {
    db = e.target.result;
    cargarTodos();
  };
  req.onerror = e => {
    console.error('IndexedDB error', e);
    alert('Error al acceder al almacenamiento local.');
  };
}

function a√±adirDB(obj){
  const tx = db.transaction('movs','readwrite');
  tx.objectStore('movs').add(obj);
  tx.oncomplete = () => cargarTodos();
  tx.onerror = e => console.error('add err', e);
}

function borrarDB(id){
  const tx = db.transaction('movs','readwrite');
  tx.objectStore('movs').delete(Number(id));
  tx.oncomplete = () => cargarTodos();
  tx.onerror = e => console.error('del err', e);
}

function cargarTodos(){
  const tx = db.transaction('movs','readonly');
  const req = tx.objectStore('movs').getAll();
  req.onsuccess = () => {
    movimientos = req.result || [];
    movimientos.sort((a,b)=> new Date(a.fecha) - new Date(b.fecha));
    renderTable();
    actualizarResumenCards();
    // if graphs/resumen open -> regenerate
    if(document.getElementById('graficosPanel').style.display === 'block') generarGraficos();
    if(document.getElementById('resumenPanel').style.display === 'block') generarResumen();
  };
  req.onerror = e => console.error('getAll err', e);
}

/* ===== UI / form logic ===== */
function toggleCategoria(){
  const tipo = document.getElementById('tipo').value;
  const catCell = document.getElementById('categoriaCell');
  const catHeader = document.getElementById('categoriaHeader');
  if(tipo === 'ingreso'){ catCell.style.display = 'none'; catHeader.style.display='none'; }
  else { catCell.style.display = 'table-cell'; catHeader.style.display='table-cell'; }
}

function agregarMovimiento(){
  const fecha = document.getElementById('fecha').value;
  const tipo = document.getElementById('tipo').value;
  const categoria = tipo === 'gasto' ? document.getElementById('categoria').value : '';
  const importeRaw = document.getElementById('importe').value;
  const importe = parseFloat(importeRaw);
  if(!fecha || !importeRaw || isNaN(importe)) return alert('Completa fecha y un importe v√°lido.');
  a√±adirDB({ fecha, tipo, categoria, importe });
  document.getElementById('importe').value = '';
}

/* ===== Table rendering ===== */
const tbody = document.querySelector('#tablaMovimientos tbody');

function renderTable(){
  tbody.innerHTML = '';
  const copia = [...movimientos].sort((a,b)=>{
    const da = new Date(a.fecha), db = new Date(b.fecha);
    return ordenAsc ? da - db : db - da;
  });
  copia.forEach(m=>{
    const tr = document.createElement('tr');
    tr.classList.add(m.tipo === 'ingreso' ? 'ingreso' : 'gasto');
    const fechaDisplay = m.fecha.split('-').reverse().join('-');
    const impClass = m.tipo === 'ingreso' ? 'importe-ingreso' : 'importe-gasto';
    tr.innerHTML = `
      <td>${fechaDisplay}</td>
      <td>${m.tipo}</td>
      <td>${m.categoria || ''}</td>
      <td class="importe-col ${impClass}">${m.tipo==='ingreso'?'+':'-'}${m.importe.toFixed(2)} ‚Ç¨</td>
      <td class="action-col"><button onclick="confirmBorrar(${m.id})">‚ùå</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function confirmBorrar(id){
  if(confirm('¬øEliminar este movimiento?')) borrarDB(id);
}

/* ===== Totals top-right ===== */
function actualizarResumenCards(){
  const ingresos = movimientos.filter(m=>m.tipo==='ingreso').reduce((s,m)=>s+m.importe,0);
  const gastos = movimientos.filter(m=>m.tipo==='gasto').reduce((s,m)=>s+m.importe,0);
  const balance = ingresos - gastos;
  document.getElementById('totalIngresos').textContent = ingresos.toFixed(2) + ' ‚Ç¨';
  document.getElementById('totalGastos').textContent = gastos.toFixed(2) + ' ‚Ç¨';
  const s = document.getElementById('saldo');
  s.textContent = balance.toFixed(2) + ' ‚Ç¨';
  s.style.color = balance>0? 'var(--verde)' : balance<0? 'var(--rojo)' : '#222';
}

/* ===== Tabs navigation ===== */
function resetNav(){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
}
function hideAllPanels(){
  document.getElementById('graficosPanel').style.display='none';
  document.getElementById('resumenPanel').style.display='none';
  // home is left column content; keep visible by default
}
function showTab(tab){
  // default: show home content (left column always visible)
  resetNav(); hideAllPanels();
  if(tab === 'home'){
    document.getElementById('nav-home').classList.add('active');
    // nothing else (home is main left visible)
    // scroll to top of app
    document.querySelector('.app').scrollIntoView({behavior:'smooth'});
  } else if(tab === 'graficos'){
    document.getElementById('nav-graphs').classList.add('active');
    document.getElementById('graficosPanel').style.display='block';
    // set default month to current if empty
    if(!document.getElementById('grafMes').value) document.getElementById('grafMes').value = obtenerMesActual();
    generarGraficos();
    document.querySelector('.app').scrollIntoView({behavior:'smooth'});
  } else if(tab === 'resumen'){
    document.getElementById('nav-summary').classList.add('active');
    document.getElementById('resumenPanel').style.display='block';
    if(!document.getElementById('resMes').value) document.getElementById('resMes').value = obtenerMesActual();
    generarResumen();
    document.querySelector('.app').scrollIntoView({behavior:'smooth'});
  }
}

/* ===== Charts (graphs) ===== */
let chartCat, chartBar, chartGrafBar;

function generarGraficos(){
  const month = document.getElementById('grafMes').value; // 'YYYY-MM' or ''
  const tipo = document.getElementById('grafTipo').value; // todos/ingreso/gasto

  // Filtrar seg√∫n month & tipo
  let fil = [...movimientos];
  if(month) fil = fil.filter(m=> m.fecha.startsWith(month));
  if(tipo !== 'todos') fil = fil.filter(m=> m.tipo === tipo);

  // por categoria (gastos)
  const porCat = {};
  fil.filter(m=> m.tipo==='gasto').forEach(m => porCat[m.categoria] = (porCat[m.categoria] || 0) + m.importe);

  // datos barras: ingresos vs gastos totals for month
  const totalIngresos = fil.filter(m=> m.tipo==='ingreso').reduce((s,m)=> s + m.importe, 0);
  const totalGastos = fil.filter(m=> m.tipo==='gasto').reduce((s,m)=> s + m.importe, 0);

  const ctxCat = document.getElementById('grafCat').getContext('2d');
  const ctxBar = document.getElementById('grafBar').getContext('2d');

  if(chartCat) chartCat.destroy();
  chartCat = new Chart(ctxCat, {
    type: 'doughnut',
    data: { labels: Object.keys(porCat), datasets: [{ data: Object.values(porCat), backgroundColor: ["#f44336","#ff9800","#2196f3","#9c27b0","#4caf50"] }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
  });

  if(chartBar) chartBar.destroy();
  chartBar = new Chart(ctxBar, {
    type: 'bar',
    data: {
      labels: ['Seleccionado'],
      datasets: [
        { label:'Ingresos', data:[totalIngresos], backgroundColor:'#4caf50' },
        { label:'Gastos', data:[totalGastos], backgroundColor:'#f44336' }
      ]
    },
    options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
  });
}

/* ===== Resumen (month picker) ===== */
let resDough, resBar;
function generarResumen(){
  const month = document.getElementById('resMes').value || obtenerMesActual();
  // filter by month (YYYY-MM)
  const movMes = movimientos.filter(m => m.fecha.startsWith(month));
  const ingresos = movMes.filter(m=> m.tipo==='ingreso').reduce((s,m)=> s + m.importe, 0);
  const gastos = movMes.filter(m=> m.tipo==='gasto').reduce((s,m)=> s + m.importe, 0);
  const balance = ingresos - gastos;

  // set textual totals
  document.getElementById('res_ing').textContent = ingresos.toFixed(2) + ' ‚Ç¨';
  document.getElementById('res_gas').textContent = gastos.toFixed(2) + ' ‚Ç¨';
  const elResSaldo = document.getElementById('res_saldo');
  elResSaldo.textContent = balance.toFixed(2) + ' ‚Ç¨';
  elResSaldo.style.color = balance>0 ? 'var(--verde)' : balance<0 ? 'var(--rojo)' : '#222';

  // doughnut categorias (gastos)
  const porCat = {};
  movMes.filter(m => m.tipo==='gasto').forEach(m => porCat[m.categoria] = (porCat[m.categoria] || 0) + m.importe);

  const ctxD = document.getElementById('resDough').getContext('2d');
  const ctxB = document.getElementById('resBar').getContext('2d');

  if(resDough) resDough.destroy();
  resDough = new Chart(ctxD, {
    type:'doughnut',
    data:{ labels:Object.keys(porCat), datasets:[{ data:Object.values(porCat), backgroundColor:["#f44336","#ff9800","#2196f3","#9c27b0","#4caf50"] }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
  });

  if(resBar) resBar.destroy();
  resBar = new Chart(ctxB, {
    type:'bar',
    data:{ labels:[obtenerNombreMes(new Date(month+'-01').getMonth()) + ' ' + new Date(month+'-01').getFullYear()], datasets:[
      { label:'Ingresos', data:[ingresos], backgroundColor:'#4caf50' },
      { label:'Gastos', data:[gastos], backgroundColor:'#f44336' }
    ] },
    options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
  });
}

/* ===== Helpers ===== */
function obtenerMesActual(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  return `${y}-${m}`;
}
function obtenerNombreMes(idx){
  const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  return meses[idx] || '';
}

/* ===== Orden toggle ===== */
function toggleOrden(){ ordenAsc = !ordenAsc; renderTable(); }

/* ===== init ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  abrirDB();
  toggleCategoria();
  // set default picks
  document.getElementById('grafMes').value = obtenerMesActual();
  document.getElementById('resMes').value = obtenerMesActual();
  // show home by default
  showTab('home');
  // listeners: regenerate graphs on change
  document.getElementById('grafMes').addEventListener('change', generarGraficos);
  document.getElementById('grafTipo').addEventListener('change', generarGraficos);
  document.getElementById('resMes').addEventListener('change', generarResumen);
});
</script>
</body>
</html>
