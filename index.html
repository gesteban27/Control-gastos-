<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Control de Gastos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="theme-color" content="#1976d2">
  <style>
    :root{
      --color-principal: #1976d2;
      --bg: #f4f6f8;
      --verde: #4caf50;
      --rojo: #f44336;
      --card: #ffffff;
      --muted: #666666;
    }

    /* ===== body & container ===== */
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin: 0;
      padding: 1rem;
      background: var(--bg);
      color: #222;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container{
      width: 100%;
      max-width: 420px; /* m√≥vil por defecto */
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(17,24,39,0.08);
      overflow: hidden;
      margin-bottom: 2rem;
      transition: max-width 0.28s ease, padding 0.28s ease;
    }

    header{
      background: linear-gradient(90deg, var(--color-principal), #2196f3);
      color: white;
      padding: 14px 16px;
    }
    header h1{ margin: 0; font-size: 1.15rem; text-align: center; font-weight: 600; }

    main{ padding: 16px; }

    /* ===== layout desktop ===== */
    @media (min-width: 768px){
      .container{ max-width: 980px; padding: 0; }
      main{ display: grid; grid-template-columns: 1fr 360px; gap: 18px; padding: 16px; }
      .left-col{ padding-right: 8px; }
      .right-col{ padding-left: 8px; }
    }

    /* ===== Resumen tarjetas ===== */
    .resumen {
      display: flex;
      gap: 10px;
      justify-content: space-between;
      align-items: stretch;
      margin-bottom: 12px;
    }
    .resumen-card{
      flex: 1;
      min-width: 0;
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }
    .resumen-card h3{ margin: 0; font-size: 0.9rem; color: var(--muted); }
    .resumen-card p{ margin: 6px 0 0; font-size: 1.15rem; font-weight: 700; }

    /* ===== tablas ===== */
    .form-table, .mov-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }
    .form-table th, .form-table td, .mov-table th, .mov-table td{
      padding: 8px;
      text-align: center;
      border-bottom: 1px solid #eee;
      font-size: 0.95rem;
    }
    .form-table thead th, .mov-table thead th{ background: #fafafa; font-weight: 600; color: #444; cursor: default; }

    .form-row input, .form-row select {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ddd;
      box-sizing: border-box;
      font-size: 0.95rem;
    }

    .btn-primary {
      background: var(--color-principal);
      color: white;
      border: none;
      padding: 8px 10px;
      border-radius: 8px;
      width: 100%;
      cursor: pointer;
      font-weight: 700;
    }
    .btn-primary:hover { background: #0d47a1; }

    .accion-col{ width: 4rem; }

    /* ===== filas colores & importe ===== */
    tr.ingreso { background-color: rgba(76,175,80,0.06); }
    tr.gasto   { background-color: rgba(244,67,54,0.06); }

    .importe-col { text-align: right; font-weight: 700; }
    .importe-ingreso { color: var(--verde); }
    .importe-gasto { color: var(--rojo); }

    /* ===== controls & nav ===== */
    .controls { display:flex; gap:8px; margin-top:12px; justify-content:center; }
    .bottom-nav {
      display:flex;
      gap:8px;
      padding:10px;
      border-top:1px solid #eee;
      background:#fff;
      justify-content:space-around;
      position: sticky;
      bottom: 0;
    }
    .nav-btn { background: none; border: none; padding:6px 10px; cursor:pointer; font-weight:600; color:#333; display:flex; flex-direction:column; align-items:center; gap:4px; }
    .nav-btn.active { color: var(--color-principal); }

    /* ===== graficos & resumen section ===== */
    #graficosSection, #resumenSection { display: none; }
    canvas{ width:100% !important; height:240px !important; border-radius:8px; }

    /* ===== responsive tweaks ===== */
    @media (max-width:420px){
      .form-table th, .form-table td, .mov-table th, .mov-table td{ padding:6px; font-size:0.9rem; }
      canvas{ height:200px !important; }
    }
  </style>
</head>
<body>
  <div class="container" role="application" aria-label="App Control de Gastos">
    <header><h1>Control de Gastos</h1></header>

    <main>
      <!-- LEFT column -->
      <div class="left-col">
        <!-- Home section -->
        <section id="homeSection" aria-label="Inicio">
          <!-- Form -->
          <table class="form-table" aria-label="Formulario">
            <thead>
              <tr>
                <th>Fecha</th><th>Tipo</th><th id="categoriaHeader">Categor√≠a</th><th>Importe (‚Ç¨)</th><th>Acci√≥n</th>
              </tr>
            </thead>
            <tbody>
              <tr class="form-row" id="formRow">
                <td><input id="fecha" type="date" /></td>
                <td>
                  <select id="tipo" onchange="toggleCategoria()">
                    <option value="ingreso">Ingreso</option>
                    <option value="gasto">Gasto</option>
                  </select>
                </td>
                <td id="categoriaCell">
                  <select id="categoria">
                    <option>Casa</option>
                    <option>Alimentaci√≥n</option>
                    <option>Ocio</option>
                    <option>Impuestos</option>
                  </select>
                </td>
                <td><input id="importe" type="number" step="0.01" /></td>
                <td><button class="btn-primary" onclick="agregarMovimiento()">‚ûï</button></td>
              </tr>
            </tbody>
          </table>

          <!-- Movements table -->
          <table class="mov-table" id="tablaMovimientos" aria-label="Lista de movimientos">
            <thead>
              <tr>
                <th onclick="toggleOrden()">Fecha ‚¨ç</th>
                <th>Tipo</th>
                <th>Categor√≠a</th>
                <th>Importe</th>
                <th class="accion-col">Acci√≥n</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div class="controls">
            <button class="btn-primary" onclick="showTab('graficos')">üìä Gr√°ficos</button>
            <button class="btn-primary" onclick="showTab('resumen')">üìÖ Resumen</button>
          </div>
        </section>
      </div>

      <!-- RIGHT column -->
      <div class="right-col">
        <!-- Cards resumen (visible en desktop and mobile) -->
        <div class="resumen" id="resumenCards" aria-hidden="false">
          <div class="resumen-card">
            <h3>Ingresos</h3>
            <p id="totalIngresos">0.00</p>
          </div>
          <div class="resumen-card">
            <h3>Gastos</h3>
            <p id="totalGastos">0.00</p>
          </div>
          <div class="resumen-card">
            <h3>Saldo</h3>
            <p id="saldo" class="negro">0.00</p>
          </div>
        </div>

        <!-- Gr√°ficos (pesta√±a) -->
        <div id="graficosSection" aria-hidden="true">
          <div style="text-align:center; margin:8px 0;">
            <button class="btn-primary" onclick="showTab('home')">üîô Volver</button>
          </div>
          <h4 style="margin:10px 0 6px;">Evoluci√≥n del saldo</h4>
          <canvas id="graficoEvolucion"></canvas>

          <h4 style="margin:10px 0 6px;">Reparto por categor√≠a (gastos)</h4>
          <canvas id="graficoCategorias"></canvas>

          <h4 style="margin:10px 0 6px;">Ingresos vs Gastos por mes</h4>
          <canvas id="graficoMensual"></canvas>
        </div>

        <!-- Resumen mensual (pesta√±a) -->
        <div id="resumenSection" aria-hidden="true">
          <div style="text-align:center; margin:8px 0;">
            <button class="btn-primary" onclick="showTab('home')">üîô Volver</button>
          </div>
          <h3 id="resumenMesTitulo" style="margin-top:8px;">Resumen</h3>

          <div style="display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; margin-top:6px;">
            <div style="min-width:140px; text-align:center; background:#fff; padding:10px; border-radius:10px; box-shadow: 0 1px 4px rgba(0,0,0,0.06);">
              <div style="font-size:0.9rem; color:var(--muted)">Ingresos</div>
              <div id="res_ingresos" style="font-weight:800; font-size:1.1rem">0.00 ‚Ç¨</div>
            </div>
            <div style="min-width:140px; text-align:center; background:#fff; padding:10px; border-radius:10px; box-shadow: 0 1px 4px rgba(0,0,0,0.06);">
              <div style="font-size:0.9rem; color:var(--muted)">Gastos</div>
              <div id="res_gastos" style="font-weight:800; font-size:1.1rem">0.00 ‚Ç¨</div>
            </div>
            <div style="min-width:140px; text-align:center; background:#fff; padding:10px; border-radius:10px; box-shadow: 0 1px 4px rgba(0,0,0,0.06);">
              <div style="font-size:0.9rem; color:var(--muted)">Saldo</div>
              <div id="res_saldo" style="font-weight:800; font-size:1.1rem">0.00 ‚Ç¨</div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <h4 style="margin:8px 0 6px;">Distribuci√≥n de gastos por categor√≠a</h4>
            <canvas id="res_doughnut"></canvas>
          </div>

          <div style="margin-top:12px;">
            <h4 style="margin:8px 0 6px;">Ingresos vs Gastos (mes)</h4>
            <canvas id="res_bar"></canvas>
          </div>
        </div>
      </div>
    </main>

    <!-- bottom nav (visible en m√≥vil y escritorio) -->
    <nav class="bottom-nav" role="navigation" aria-label="Navegaci√≥n principal">
      <button class="nav-btn active" id="nav-home" onclick="showTab('home')">üè†<span style="font-size:0.72rem">Inicio</span></button>
      <button class="nav-btn" id="nav-graficos" onclick="showTab('graficos')">üìä<span style="font-size:0.72rem">Gr√°ficos</span></button>
      <button class="nav-btn" id="nav-resumen" onclick="showTab('resumen')">üìÖ<span style="font-size:0.72rem">Resumen</span></button>
    </nav>
  </div>

<script>
/* ========== IndexedDB ========== */
let db;
let movimientos = [];
let ordenAsc = false;

function abrirBD() {
  const req = indexedDB.open("GastosFamiliaDB_v2", 1);
  req.onupgradeneeded = (e) => {
    db = e.target.result;
    if (!db.objectStoreNames.contains("movimientos")) {
      const store = db.createObjectStore("movimientos", { keyPath: "id", autoIncrement: true });
      store.createIndex("fecha", "fecha", { unique: false });
    }
  };
  req.onsuccess = (e) => {
    db = e.target.result;
    cargarMovimientos();
  };
  req.onerror = (e) => {
    console.error("Error IndexedDB", e);
    alert("Error accediendo al almacenamiento local.");
  };
}

function agregarRegistroDB(obj) {
  const tx = db.transaction("movimientos","readwrite");
  const store = tx.objectStore("movimientos");
  store.add(obj);
  tx.oncomplete = () => cargarMovimientos();
  tx.onerror = e => console.error("add error", e);
}

function borrarRegistroDB(id) {
  const tx = db.transaction("movimientos","readwrite");
  const store = tx.objectStore("movimientos");
  store.delete(Number(id));
  tx.oncomplete = () => cargarMovimientos();
  tx.onerror = e => console.error("delete err", e);
}

function cargarMovimientos() {
  const tx = db.transaction("movimientos","readonly");
  const store = tx.objectStore("movimientos");
  const req = store.getAll();
  req.onsuccess = () => {
    movimientos = req.result || [];
    movimientos.sort((a,b)=> new Date(a.fecha) - new Date(b.fecha));
    renderMovimientos();
    actualizarTotales();
    // si est√°s en gr√°ficas/resumen y ya abiertas, regenerarlas
    if(document.getElementById('graficosSection').style.display === 'block') generarGraficos();
    if(document.getElementById('resumenSection').style.display === 'block') generarResumen();
  };
  req.onerror = e => console.error("getAll err", e);
}

/* ========== UI / l√≥gica ========== */
const tbody = document.querySelector("#tablaMovimientos tbody");
const elTotalIngresos = document.getElementById("totalIngresos");
const elTotalGastos = document.getElementById("totalGastos");
const elSaldo = document.getElementById("saldo");

function toggleCategoria(){
  const tipo = document.getElementById("tipo").value;
  const catCell = document.getElementById("categoriaCell");
  const catHeader = document.getElementById("categoriaHeader");
  if(tipo === "ingreso"){
    catCell.style.display = "none";
    catHeader.style.display = "none";
  } else {
    catCell.style.display = "table-cell";
    catHeader.style.display = "table-cell";
  }
}

function agregarMovimiento(){
  const fechaRaw = document.getElementById("fecha").value;
  const tipo = document.getElementById("tipo").value;
  const categoria = tipo === "gasto" ? document.getElementById("categoria").value : "";
  const importeRaw = document.getElementById("importe").value;
  const importe = parseFloat(importeRaw);
  if(!fechaRaw || !importeRaw || isNaN(importe)){
    return alert("Por favor completa fecha y un importe v√°lido.");
  }
  agregarRegistroDB({ fecha: fechaRaw, tipo, categoria, importe });
  document.getElementById("importe").value = "";
}

function renderMovimientos(){
  tbody.innerHTML = "";
  const copia = [...movimientos].sort((a,b)=>{
    const da = new Date(a.fecha), db = new Date(b.fecha);
    return ordenAsc ? da - db : db - da;
  });

  copia.forEach(m=>{
    const tr = document.createElement("tr");
    tr.classList.add(m.tipo === "ingreso" ? "ingreso" : "gasto");
    const fechaDisplay = m.fecha.split("-").reverse().join("-");
    const importeClass = m.tipo === "ingreso" ? "importe-ingreso" : "importe-gasto";
    tr.innerHTML = `
      <td>${fechaDisplay}</td>
      <td>${m.tipo}</td>
      <td>${m.categoria || ""}</td>
      <td class="importe-col ${importeClass}">${m.tipo === "ingreso" ? "+" : "-"}${m.importe.toFixed(2)} ‚Ç¨</td>
      <td class="accion-col"><button onclick="borrarMovimiento(${m.id})">‚ùå</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function borrarMovimiento(id){
  if(confirm("¬øEliminar este movimiento?")) {
    borrarRegistroDB(id);
  }
}

function actualizarTotales(){
  const ingresos = movimientos.filter(m => m.tipo === "ingreso").reduce((s,m)=> s + m.importe, 0);
  const gastos = movimientos.filter(m => m.tipo === "gasto").reduce((s,m)=> s + m.importe, 0);
  const balance = ingresos - gastos;
  elTotalIngresos.textContent = ingresos.toFixed(2);
  elTotalGastos.textContent = gastos.toFixed(2);
  elSaldo.textContent = balance.toFixed(2);
  elSaldo.className = balance > 0 ? "verde" : balance < 0 ? "rojo" : "negro";
}

/* ========== Navegaci√≥n de pesta√±as ========== */
function clearActiveNav(){
  document.getElementById("nav-home").classList.remove("active");
  document.getElementById("nav-graficos").classList.remove("active");
  document.getElementById("nav-resumen").classList.remove("active");
}

function showTab(tab){
  // esconder todo
  document.getElementById("homeSection").style.display = 'none';
  document.getElementById("graficosSection").style.display = 'none';
  document.getElementById("resumenSection").style.display = 'none';
  document.getElementById("graficosSection").setAttribute('aria-hidden','true');
  document.getElementById("resumenSection").setAttribute('aria-hidden','true');

  clearActiveNav();

  if(tab === 'home'){
    document.getElementById("homeSection").style.display = 'block';
    document.getElementById("nav-home").classList.add("active");
  } else if(tab === 'graficos'){
    document.getElementById("graficosSection").style.display = 'block';
    document.getElementById("graficosSection").setAttribute('aria-hidden','false');
    document.getElementById("nav-graficos").classList.add("active");
    generarGraficos();
  } else if(tab === 'resumen'){
    document.getElementById("resumenSection").style.display = 'block';
    document.getElementById("resumenSection").setAttribute('aria-hidden','false');
    document.getElementById("nav-resumen").classList.add("active");
    generarResumen();
  }
  // scroll to top of container
  document.querySelector('.container').scrollIntoView({behavior:'smooth'});
}

/* ========== Gr√°ficos (Chart.js) ========== */
let chart1, chart2, chart3;
function generarGraficos(){
  const ctx1 = document.getElementById("graficoEvolucion").getContext("2d");
  const ctx2 = document.getElementById("graficoCategorias").getContext("2d");
  const ctx3 = document.getElementById("graficoMensual").getContext("2d");

  if(chart1) chart1.destroy();
  if(chart2) chart2.destroy();
  if(chart3) chart3.destroy();

  // Evoluci√≥n: saldo acumulado por fecha
  const fechas = [...new Set(movimientos.map(m => m.fecha))].sort((a,b)=> new Date(a)-new Date(b));
  let acum = 0;
  const dataEvol = fechas.map(f=>{
    movimientos.filter(m=>m.fecha===f).forEach(m=> acum += (m.tipo === "ingreso" ? m.importe : -m.importe));
    return acum;
  });

  chart1 = new Chart(ctx1, {
    type: "line",
    data: {
      labels: fechas.map(f=>f.split("-").reverse().join("-")),
      datasets: [{ label: "Saldo acumulado (‚Ç¨)", data: dataEvol, borderColor: "#1976d2", backgroundColor: "rgba(25,118,210,0.18)", fill:true }]
    },
    options: { responsive:true, maintainAspectRatio:false }
  });

  // Por categor√≠a (solo gastos)
  const porCat = {};
  movimientos.filter(m=> m.tipo === "gasto").forEach(m => porCat[m.categoria] = (porCat[m.categoria] || 0) + m.importe);

  chart2 = new Chart(ctx2, {
    type: "doughnut",
    data: { labels: Object.keys(porCat), datasets: [{ data: Object.values(porCat), backgroundColor: ["#f44336","#ff9800","#2196f3","#9c27b0","#4caf50"] }] },
    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
  });

  // Mensual: ingresos vs gastos por mes
  const meses = {};
  movimientos.forEach(m=>{
    const [anio, mes] = m.fecha.split("-").slice(0,2);
    const k = `${mes}-${anio}`;
    if(!meses[k]) meses[k] = { ingresos:0, gastos:0 };
    if(m.tipo === "ingreso") meses[k].ingresos += m.importe;
    else meses[k].gastos += m.importe;
  });

  const keysMeses = Object.keys(meses).sort((a,b)=>{
    const [ma,aa] = a.split("-"), [mb,ab] = b.split("-");
    return new Date(`${aa}-${ma}-01`) - new Date(`${ab}-${mb}-01`);
  });

  chart3 = new Chart(ctx3, {
    type: "bar",
    data: {
      labels: keysMeses,
      datasets: [
        { label: "Ingresos", data: keysMeses.map(k=>meses[k].ingresos), backgroundColor: "#4caf50" },
        { label: "Gastos", data: keysMeses.map(k=>meses[k].gastos), backgroundColor: "#f44336" }
      ]
    },
    options: { responsive:true, maintainAspectRatio:false }
  });
}

/* ========== Resumen mensual (pesta√±a) ========== */
let resChartDoughnut, resChartBar;
function generarResumen(){
  // calcular mes actual
  const hoy = new Date();
  const mes = String(hoy.getMonth()+1).padStart(2,'0');
  const anio = String(hoy.getFullYear());
  const mesClave = `${anio}-${mes}`; // formato yyyy-mm

  // filtrar movimientos del mes actual
  const movMes = movimientos.filter(m => m.fecha.startsWith(mesClave));

  const ingresos = movMes.filter(m => m.tipo === 'ingreso').reduce((s,m)=> s + m.importe, 0);
  const gastos = movMes.filter(m => m.tipo === 'gasto').reduce((s,m)=> s + m.importe, 0);
  const balance = ingresos - gastos;

  document.getElementById('resumenMesTitulo').textContent = `${obtenerNombreMes(hoy.getMonth())} ${anio}`;
  document.getElementById('res_ingresos').textContent = ingresos.toFixed(2) + ' ‚Ç¨';
  document.getElementById('res_gastos').textContent = gastos.toFixed(2) + ' ‚Ç¨';
  const elResSaldo = document.getElementById('res_saldo');
  elResSaldo.textContent = balance.toFixed(2) + ' ‚Ç¨';
  elResSaldo.style.color = balance > 0 ? 'var(--verde)' : balance < 0 ? 'var(--rojo)' : '#222';

  // doughnut por categor√≠a (gastos)
  const porCat = {};
  movMes.filter(m => m.tipo === 'gasto').forEach(m => porCat[m.categoria] = (porCat[m.categoria] || 0) + m.importe);

  const ctxD = document.getElementById('res_doughnut').getContext('2d');
  if(resChartDoughnut) resChartDoughnut.destroy();
  resChartDoughnut = new Chart(ctxD, {
    type: 'doughnut',
    data: { labels: Object.keys(porCat), datasets: [{ data: Object.values(porCat), backgroundColor: ["#f44336","#ff9800","#2196f3","#9c27b0","#4caf50"] }] },
    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
  });

  // barras: ingresos vs gastos (solo totals del mes)
  const ctxB = document.getElementById('res_bar').getContext('2d');
  if(resChartBar) resChartBar.destroy();
  resChartBar = new Chart(ctxB, {
    type: 'bar',
    data: {
      labels: ['Mes actual'],
      datasets: [
        { label:'Ingresos', data:[ingresos], backgroundColor: '#4caf50' },
        { label:'Gastos', data:[gastos], backgroundColor: '#f44336' }
      ]
    },
    options: { responsive:true, maintainAspectRatio:false }
  });
}

/* ========== Orden toggle ========== */
function toggleOrden(){
  ordenAsc = !ordenAsc;
  renderMovimientos();
}

/* ========== helper mes nombre ========== */
function obtenerNombreMes(idx){
  const nombres = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  return nombres[idx] || '';
}

/* ========== init ========== */
document.addEventListener('DOMContentLoaded', () => {
  abrirBD();
  toggleCategoria();
  // mostrar home por defecto
  showTab('home');
});
</script>
</body>
</html>
