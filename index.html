<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control de Gastos Familiar</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --color-principal: #1976d2;
      --color-fondo: #f4f6f8;
      --verde: #4caf50;
      --rojo: #f44336;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--color-fondo);
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 900px;
      margin: auto;
    }

    h1 {
      background: var(--color-principal);
      color: white;
      padding: 12px;
      text-align: center;
      width: 100%;
      margin: 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    table {
      border-collapse: collapse;
      width: 95%;
      margin: 10px auto;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 8px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #e0e0e0;
    }

    td.ingreso { color: var(--verde); }
    td.gasto { color: var(--rojo); }

    tr.ingreso { background-color: rgba(76,175,80,0.1); }
    tr.gasto { background-color: rgba(244,67,54,0.1); }

    .accion-col { width: 4rem; }

    .resumen {
      width: 95%;
      margin: 10px auto;
      display: flex;
      justify-content: space-around;
    }

    .resumen table {
      width: 100%;
      text-align: center;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .inputs table {
      width: 95%;
      margin: 10px auto;
      background: white;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    input, select, button {
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
      width: 100%;
    }

    button {
      background: var(--color-principal);
      color: white;
      cursor: pointer;
      border: none;
      transition: 0.3s;
    }

    button:hover {
      background: #0d47a1;
    }

    #saldo {
      font-weight: bold;
    }

    #saldo.verde { color: var(--verde); }
    #saldo.rojo { color: var(--rojo); }
    #saldo.negro { color: black; }

    #graficosSection {
      display: none;
      width: 95%;
      text-align: center;
    }

    canvas {
      background: white;
      border-radius: 10px;
      padding: 10px;
      margin: 15px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      width: 100%;
    }

    .botones-secundarios {
      text-align: center;
      margin-top: 10px;
    }

    @media (max-width: 600px) {
      body { max-width: 100%; }
      table, .inputs table, .resumen table { font-size: 0.9rem; }
    }
  </style>
</head>
<body>
  <h1>üí∞ Control de Gastos Familiar</h1>

  <div id="mainSection">
    <div class="resumen">
      <table>
        <tr>
          <th>Ingresos (‚Ç¨)</th>
          <th>Gastos (‚Ç¨)</th>
          <th>Saldo (‚Ç¨)</th>
        </tr>
        <tr>
          <td id="totalIngresos">0.00</td>
          <td id="totalGastos">0.00</td>
          <td id="saldo" class="negro">0.00</td>
        </tr>
      </table>
    </div>

    <div class="inputs">
      <table>
        <tr>
          <td><label>Fecha</label></td>
          <td><input type="date" id="fecha"></td>
        </tr>
        <tr>
          <td><label>Tipo</label></td>
          <td>
            <select id="tipo" onchange="toggleCategoria()">
              <option value="ingreso">Ingreso</option>
              <option value="gasto">Gasto</option>
            </select>
          </td>
        </tr>
        <tr id="filaCategoria">
          <td><label>Categor√≠a</label></td>
          <td>
            <select id="categoria">
              <option value="Casa">Casa</option>
              <option value="Alimentaci√≥n">Alimentaci√≥n</option>
              <option value="Ocio">Ocio</option>
              <option value="Impuestos">Impuestos</option>
            </select>
          </td>
        </tr>
        <tr>
          <td><label>Importe</label></td>
          <td><input type="number" id="importe" step="0.01"></td>
        </tr>
        <tr>
          <td colspan="2"><button onclick="agregarMovimiento()">‚ûï A√±adir</button></td>
        </tr>
      </table>
    </div>

    <table id="tablaMovimientos">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Tipo</th>
          <th>Categor√≠a</th>
          <th>Importe</th>
          <th class="accion-col">Acci√≥n</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="botones-secundarios">
      <button onclick="mostrarGraficos()">üìä Ver Gr√°ficos</button>
      <button onclick="exportarDatos()">üíæ Exportar</button>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="importarDatos(event)">
      <button onclick="document.getElementById('importFile').click()">üìÇ Importar</button>
    </div>
  </div>

  <div id="graficosSection">
    <button onclick="volverPrincipal()">üîô Volver</button>
    <h2>üìà Evoluci√≥n del Saldo</h2>
    <canvas id="graficoEvolucion"></canvas>
    <h2>ü•ß Reparto por Categor√≠a</h2>
    <canvas id="graficoCategorias"></canvas>
    <h2>üìä Ingresos vs Gastos Mensuales</h2>
    <canvas id="graficoMensual"></canvas>
  </div>

  <script>
    let movimientos = JSON.parse(localStorage.getItem("movimientos")) || [];

    const tabla = document.querySelector("#tablaMovimientos tbody");
    const totalIngresos = document.getElementById("totalIngresos");
    const totalGastos = document.getElementById("totalGastos");
    const saldo = document.getElementById("saldo");
    let chart1, chart2, chart3;

    function toggleCategoria() {
      const tipo = document.getElementById("tipo").value;
      document.getElementById("filaCategoria").style.display = tipo === "gasto" ? "table-row" : "none";
    }

    function agregarMovimiento() {
      const fecha = document.getElementById("fecha").value;
      const tipo = document.getElementById("tipo").value;
      const categoria = tipo === "gasto" ? document.getElementById("categoria").value : "";
      const importe = parseFloat(document.getElementById("importe").value);

      if (!fecha || !importe) return alert("Completa todos los campos");

      movimientos.push({ fecha, tipo, categoria, importe });
      movimientos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
      localStorage.setItem("movimientos", JSON.stringify(movimientos));

      renderMovimientos();
      actualizarTotales();
      document.getElementById("importe").value = "";
    }

    function borrarMovimiento(index) {
      movimientos.splice(index, 1);
      localStorage.setItem("movimientos", JSON.stringify(movimientos));
      renderMovimientos();
      actualizarTotales();
    }

    function renderMovimientos() {
      tabla.innerHTML = "";
      movimientos.forEach((m, index) => {
        const fila = document.createElement("tr");
        fila.classList.add(m.tipo);
        fila.innerHTML = `
          <td>${m.fecha.split("-").reverse().join("-")}</td>
          <td>${m.tipo}</td>
          <td>${m.categoria || ""}</td>
          <td class="${m.tipo}">${m.tipo === "ingreso" ? "+" : "-"}${m.importe.toFixed(2)} ‚Ç¨</td>
          <td class="accion-col"><button onclick="borrarMovimiento(${index})">‚ùå</button></td>
        `;
        tabla.appendChild(fila);
      });
    }

    function actualizarTotales() {
      const ingresos = movimientos.filter(m => m.tipo === "ingreso").reduce((sum, m) => sum + m.importe, 0);
      const gastos = movimientos.filter(m => m.tipo === "gasto").reduce((sum, m) => sum + m.importe, 0);
      const balance = ingresos - gastos;

      totalIngresos.textContent = ingresos.toFixed(2);
      totalGastos.textContent = gastos.toFixed(2);
      saldo.textContent = balance.toFixed(2);

      saldo.className = balance > 0 ? "verde" : balance < 0 ? "rojo" : "negro";
    }

    function exportarDatos() {
      const blob = new Blob([JSON.stringify(movimientos, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "gastos_familia.json";
      a.click();
    }

    function importarDatos(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          movimientos = JSON.parse(e.target.result);
          localStorage.setItem("movimientos", JSON.stringify(movimientos));
          renderMovimientos();
          actualizarTotales();
          alert("Datos importados correctamente ‚úÖ");
        } catch {
          alert("Error al importar los datos");
        }
      };
      reader.readAsText(file);
    }

    function mostrarGraficos() {
      document.getElementById("mainSection").style.display = "none";
      document.getElementById("graficosSection").style.display = "block";
      generarGraficos();
    }

    function volverPrincipal() {
      document.getElementById("graficosSection").style.display = "none";
      document.getElementById("mainSection").style.display = "block";
    }

    function generarGraficos() {
      const ctx1 = document.getElementById("graficoEvolucion");
      const ctx2 = document.getElementById("graficoCategorias");
      const ctx3 = document.getElementById("graficoMensual");

      if (chart1) chart1.destroy();
      if (chart2) chart2.destroy();
      if (chart3) chart3.destroy();

      // Evoluci√≥n del saldo
      const fechas = [...new Set(movimientos.map(m => m.fecha))].sort((a,b) => new Date(a)-new Date(b));
      let saldoAcumulado = 0;
      const dataEvol = fechas.map(f => {
        const movDia = movimientos.filter(m => m.fecha === f);
        movDia.forEach(m => saldoAcumulado += (m.tipo === "ingreso" ? m.importe : -m.importe));
        return saldoAcumulado;
      });

      chart1 = new Chart(ctx1, {
        type: "line",
        data: {
          labels: fechas.map(f => f.split("-").reverse().join("-")),
          datasets: [{
            label: "Saldo acumulado (‚Ç¨)",
            data: dataEvol,
            borderColor: "#1976d2",
            backgroundColor: "rgba(25,118,210,0.2)",
            fill: true
          }]
        }
      });

      // Por categor√≠a
      const categorias = {};
      movimientos.filter(m => m.tipo === "gasto").forEach(m => {
        categorias[m.categoria] = (categorias[m.categoria] || 0) + m.importe;
      });

      chart2 = new Chart(ctx2, {
        type: "doughnut",
        data: {
          labels: Object.keys(categorias),
          datasets: [{
            data: Object.values(categorias),
            backgroundColor: ["#f44336","#ff9800","#2196f3","#9c27b0"]
          }]
        }
      });

      // Ingresos vs Gastos Mensuales
      const meses = {};
      movimientos.forEach(m => {
        const [anio, mes] = m.fecha.split("-").slice(0,2);
        const clave = `${mes}-${anio}`;
        if (!meses[clave]) meses[clave] = { ingresos: 0, gastos: 0 };
        if (m.tipo === "ingreso") meses[clave].ingresos += m.importe;
        else meses[clave].gastos += m.importe;
      });

      chart3 = new Chart(ctx3, {
        type: "bar",
        data: {
          labels: Object.keys(meses),
          datasets: [
            { label: "Ingresos", data: Object.values(meses).map(m => m.ingresos), backgroundColor: "#4caf50" },
            { label: "Gastos", data: Object.values(meses).map(m => m.gastos), backgroundColor: "#f44336" }
          ]
        }
      });
    }

    toggleCategoria();
    renderMovimientos();
    actualizarTotales();
  </script>
</body>
</html>
