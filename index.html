<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Control de Gastos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="theme-color" content="#1976d2">
  <style>
    :root{
      --color-principal: #1976d2;
      --color-fondo: #f4f6f8;
      --verde: #4caf50;
      --rojo: #f44336;
    }

    /* ===== Body & container ===== */
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin: 0;
      padding: 1rem;
      background: var(--color-fondo);
      color: #222;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container{
      width: 100%;
      max-width: 420px; /* m√≥vil por defecto */
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(17,24,39,0.08);
      overflow: hidden;
      margin-bottom: 2rem;
      transition: max-width 0.28s ease, padding 0.28s ease;
    }

    /* ===== Header ===== */
    header{
      background: linear-gradient(90deg, var(--color-principal), #2196f3);
      color: white;
      padding: 14px 16px;
    }
    header h1{
      margin: 0;
      font-size: 1.15rem;
      text-align: center;
      font-weight: 600;
    }

    main{ padding: 16px; }

    /* ===== Resumen tarjetas ===== */
    .resumen {
      display: flex;
      gap: 10px;
      justify-content: space-between;
      align-items: stretch;
      margin-bottom: 12px;
    }
    .resumen-card{
      flex: 1;
      min-width: 0;
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }
    .resumen-card h3{ margin: 0; font-size: 0.9rem; color: #666; }
    .resumen-card p{ margin: 6px 0 0; font-size: 1.15rem; font-weight: 700; }

    /* ===== Formulario tabulado ===== */
    .form-table, .mov-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }
    .form-table th, .form-table td, .mov-table th, .mov-table td{
      padding: 8px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }
    .form-table thead th{ background: #fafafa; font-weight: 600; color: #444; }
    .mov-table thead th{ background: #fafafa; font-weight: 600; color: #444; }

    .form-row input, .form-row select {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ddd;
      box-sizing: border-box;
      font-size: 0.95rem;
    }

    .btn-primary {
      background: var(--color-principal);
      color: white;
      border: none;
      padding: 8px 10px;
      border-radius: 8px;
      width: 100%;
      cursor: pointer;
      font-weight: 700;
    }
    .btn-primary:hover { background: #0d47a1; }

    .accion-col{ width: 4rem; }

    /* ===== Colores filas/importe ===== */
    tr.ingreso { background-color: rgba(76,175,80,0.08); }
    tr.gasto { background-color: rgba(244,67,54,0.06); }

    .importe-col { text-align: right; font-weight: 700; }
    .importe-ingreso { color: var(--verde); }
    .importe-gasto { color: var(--rojo); }

    /* ===== Botones inferiores ===== */
    .controls { display: flex; gap: 8px; margin-top: 12px; justify-content: center; }
    .controls button { flex: 1; }

    /* ===== Gr√°ficos ===== */
    #graficosSection{ display: none; padding: 8px 0 20px; }
    canvas{ width: 100% !important; height: 260px !important; border-radius: 8px; }

    /* ===== Saldo colores ===== */
    #saldo { font-weight: 800; font-size: 1.1rem; }
    #saldo.verde { color: var(--verde); }
    #saldo.rojo { color: var(--rojo); }
    #saldo.negro { color: #222; }

    /* ===== Responsive: ampliar en escritorio/tablet ===== */
    @media (min-width: 768px){
      .container{ max-width: 980px; padding: 12px; }
      main{ display: grid; grid-template-columns: 1fr 420px; gap: 18px; }
      /* izquierda: movimientos + formulario, derecha: resumen + controles */
      .left-col{ display: flex; flex-direction: column; gap: 12px; }
      .right-col{ display:flex; flex-direction: column; gap: 12px; align-items: stretch; }
      /* mover resumen into right */
      .resumen{ flex-direction: column; gap: 12px; align-items: stretch; }
      canvas{ height: 320px !important; }
    }

    @media (max-width: 420px){
      .form-table th, .form-table td, .mov-table th, .mov-table td{ padding: 6px; font-size: 0.92rem; }
      canvas{ height: 220px !important; }
    }
  </style>
</head>
<body>
  <div class="container" role="application">
    <header><h1>Control de Gastos</h1></header>

    <main>
      <!-- Left column: formulario + movimientos -->
      <div class="left-col" style="padding: 0 16px 16px 16px;">
        <!-- Resumen (en m√≥viles se muestra arriba; en escritorio se reubica) -->
        <div class="resumen" style="display:none;" id="resumenHidden"></div>

        <!-- Formulario -->
        <div>
          <table class="form-table" aria-label="Formulario de entrada">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th id="categoriaHeader">Categor√≠a</th>
                <th>Importe (‚Ç¨)</th>
                <th>Acci√≥n</th>
              </tr>
            </thead>
            <tbody>
              <tr class="form-row" id="formRow">
                <td><input id="fecha" type="date" /></td>
                <td>
                  <select id="tipo" onchange="toggleCategoria()">
                    <option value="ingreso">Ingreso</option>
                    <option value="gasto">Gasto</option>
                  </select>
                </td>
                <td id="categoriaCell">
                  <select id="categoria">
                    <option>Casa</option>
                    <option>Alimentaci√≥n</option>
                    <option>Ocio</option>
                    <option>Impuestos</option>
                  </select>
                </td>
                <td><input id="importe" type="number" step="0.01" /></td>
                <td><button class="btn-primary" onclick="agregarMovimiento()">‚ûï</button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Movimientos -->
        <div>
          <table class="mov-table" id="tablaMovimientos" aria-label="Movimientos">
            <thead>
              <tr>
                <th onclick="toggleOrden()">Fecha ‚¨ç</th>
                <th>Tipo</th>
                <th>Categor√≠a</th>
                <th>Importe</th>
                <th class="accion-col">Acci√≥n</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Botones -->
        <div class="controls" style="padding: 0 6px;">
          <button onclick="mostrarGraficos()" class="btn-primary">üìä Ver Gr√°ficos</button>
        </div>
      </div>

      <!-- Right column: resumen + gr√°ficos (resumen tambi√©n visible en mobile above) -->
      <div class="right-col" style="padding: 0 16px 16px 16px;">
        <div class="resumen" id="resumenCards" aria-hidden="false" style="display:block;">
          <div class="resumen-card">
            <h3>Ingresos</h3>
            <p id="totalIngresos">0.00</p>
          </div>
          <div class="resumen-card">
            <h3>Gastos</h3>
            <p id="totalGastos">0.00</p>
          </div>
          <div class="resumen-card">
            <h3>Saldo</h3>
            <p id="saldo" class="negro">0.00</p>
          </div>
        </div>

        <!-- secci√≥n de gr√°ficos (interna) -->
        <div id="graficosSection" aria-hidden="true" style="display:none;">
          <div style="margin-top:8px; text-align:center;">
            <button class="btn-primary" onclick="volverPrincipal()">üîô Volver</button>
          </div>

          <h3 style="margin:12px 0 6px;">Evoluci√≥n del saldo</h3>
          <canvas id="graficoEvolucion"></canvas>

          <h3 style="margin:12px 0 6px;">Reparto por categor√≠a (gastos)</h3>
          <canvas id="graficoCategorias"></canvas>

          <h3 style="margin:12px 0 6px;">Ingresos vs Gastos por mes</h3>
          <canvas id="graficoMensual"></canvas>
        </div>
      </div>
    </main>
  </div>

<script>
/* ===============================
   IndexedDB - almacenamiento
   =============================== */
let db;
let movimientos = [];
let ordenAsc = false;

function abrirBD() {
  const req = indexedDB.open("GastosFamiliaDB_v2", 1);
  req.onupgradeneeded = (e) => {
    db = e.target.result;
    if (!db.objectStoreNames.contains("movimientos")) {
      const store = db.createObjectStore("movimientos", { keyPath: "id", autoIncrement: true });
      store.createIndex("fecha", "fecha", { unique: false });
    }
  };
  req.onsuccess = (e) => {
    db = e.target.result;
    cargarMovimientos();
  };
  req.onerror = (e) => {
    console.error("Error abriendo IndexedDB", e);
    alert("No se pudo acceder al almacenamiento local.");
  };
}

function agregarRegistroDB(obj) {
  const tx = db.transaction("movimientos","readwrite");
  const store = tx.objectStore("movimientos");
  store.add(obj);
  tx.oncomplete = () => cargarMovimientos();
  tx.onerror = (e) => console.error("Error al a√±adir", e);
}

function borrarRegistroDB(id) {
  const tx = db.transaction("movimientos","readwrite");
  const store = tx.objectStore("movimientos");
  store.delete(Number(id));
  tx.oncomplete = () => cargarMovimientos();
  tx.onerror = (e) => console.error("Error al eliminar", e);
}

function cargarMovimientos() {
  const tx = db.transaction("movimientos","readonly");
  const store = tx.objectStore("movimientos");
  const req = store.getAll();
  req.onsuccess = () => {
    movimientos = req.result || [];
    // ordenar por fecha asc por defecto
    movimientos.sort((a,b)=> new Date(a.fecha) - new Date(b.fecha));
    renderMovimientos();
    actualizarTotales();
  };
  req.onerror = (e) => console.error("Error al leer movs", e);
}

/* ===============================
   UI / l√≥gica de la app
   =============================== */

const tbody = document.querySelector("#tablaMovimientos tbody");
const elTotalIngresos = document.getElementById("totalIngresos");
const elTotalGastos = document.getElementById("totalGastos");
const elSaldo = document.getElementById("saldo");

function toggleCategoria(){
  const tipo = document.getElementById("tipo").value;
  const catCell = document.getElementById("categoriaCell");
  const catHeader = document.getElementById("categoriaHeader");
  if(tipo === "ingreso"){
    catCell.style.display = "none";
    catHeader.style.display = "none";
  } else {
    catCell.style.display = "table-cell";
    catHeader.style.display = "table-cell";
  }
}

function agregarMovimiento(){
  const fechaRaw = document.getElementById("fecha").value;
  const tipo = document.getElementById("tipo").value;
  const categoria = tipo === "gasto" ? document.getElementById("categoria").value : "";
  const importeRaw = document.getElementById("importe").value;
  const importe = parseFloat(importeRaw);
  if(!fechaRaw || !importeRaw || isNaN(importe)){
    return alert("Por favor completa fecha y importe v√°lidos.");
  }
  // guardamos la fecha tal cual (yyyy-mm-dd)
  agregarRegistroDB({ fecha: fechaRaw, tipo, categoria, importe });
  // limpiar importe
  document.getElementById("importe").value = "";
}

function renderMovimientos(){
  tbody.innerHTML = "";
  // ordenar seg√∫n ordenAsc (por defecto asc)
  const copia = [...movimientos].sort((a,b)=>{
    const da = new Date(a.fecha), db = new Date(b.fecha);
    return ordenAsc ? da - db : db - da;
  });

  copia.forEach((m)=>{
    const tr = document.createElement("tr");
    tr.classList.add(m.tipo === "ingreso" ? "ingreso" : "gasto");
    const fechaDisplay = m.fecha.split("-").reverse().join("-");
    const importeClass = m.tipo === "ingreso" ? "importe-ingreso" : "importe-gasto";
    tr.innerHTML = `
      <td>${fechaDisplay}</td>
      <td>${m.tipo}</td>
      <td>${m.categoria || ""}</td>
      <td class="importe-col ${importeClass}">${m.tipo === "ingreso" ? "+" : "-"}${m.importe.toFixed(2)} ‚Ç¨</td>
      <td class="accion-col"><button onclick="borrarMovimiento(${m.id})">‚ùå</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function borrarMovimiento(id){
  if(confirm("¬øEliminar este movimiento?")) {
    borrarRegistroDB(id);
  }
}

function actualizarTotales(){
  const ingresos = movimientos.filter(m => m.tipo === "ingreso").reduce((s,m)=> s + m.importe, 0);
  const gastos = movimientos.filter(m => m.tipo === "gasto").reduce((s,m)=> s + m.importe, 0);
  const balance = ingresos - gastos;
  elTotalIngresos.textContent = ingresos.toFixed(2);
  elTotalGastos.textContent = gastos.toFixed(2);
  elSaldo.textContent = balance.toFixed(2);
  elSaldo.className = balance > 0 ? "verde" : balance < 0 ? "rojo" : "negro";
}

/* ===============================
   Gr√°ficos (Chart.js)
   =============================== */
let chart1, chart2, chart3;
function mostrarGraficos(){
  document.getElementById("graficosSection").style.display = "block";
  // en layout de escritorio mostramos en right-col; en m√≥vil navegamos (secciones ya dentro)
  generarGraficos();
  // si est√° en dise√±o con main grid, no esconder main; aqu√≠ preferimos que muestre la secci√≥n de graficos
  // En nuestra estructura, est√° en right-col; aseguramos scroll hasta all√≠ en m√≥viles
  document.getElementById("graficosSection").scrollIntoView({behavior:"smooth"});
}

function volverPrincipal(){
  // simplemente hacemos scroll arriba y destruyimos gr√°ficos si hay
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function generarGraficos(){
  const ctx1 = document.getElementById("graficoEvolucion").getContext("2d");
  const ctx2 = document.getElementById("graficoCategorias").getContext("2d");
  const ctx3 = document.getElementById("graficoMensual").getContext("2d");

  if(chart1) chart1.destroy();
  if(chart2) chart2.destroy();
  if(chart3) chart3.destroy();

  // Evoluci√≥n: saldo acumulado por fecha
  const fechas = [...new Set(movimientos.map(m => m.fecha))].sort((a,b)=> new Date(a)-new Date(b));
  let acum = 0;
  const dataEvol = fechas.map(f=>{
    movimientos.filter(m=>m.fecha===f).forEach(m=> acum += (m.tipo === "ingreso" ? m.importe : -m.importe));
    return acum;
  });

  chart1 = new Chart(ctx1, {
    type: "line",
    data: {
      labels: fechas.map(f=>f.split("-").reverse().join("-")),
      datasets: [{ label: "Saldo acumulado (‚Ç¨)", data: dataEvol, borderColor: "#1976d2", backgroundColor: "rgba(25,118,210,0.18)", fill:true }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });

  // Por categor√≠a (solo gastos)
  const porCat = {};
  movimientos.filter(m=> m.tipo === "gasto").forEach(m => porCat[m.categoria] = (porCat[m.categoria] || 0) + m.importe);
  chart2 = new Chart(ctx2, {
    type: "doughnut",
    data: { labels: Object.keys(porCat), datasets: [{ data: Object.values(porCat), backgroundColor: ["#f44336","#ff9800","#2196f3","#9c27b0"] }] },
    options: { responsive:true, maintainAspectRatio:false }
  });

  // Mensual: ingresos vs gastos por mes
  const meses = {};
  movimientos.forEach(m=>{
    const [anio, mes] = m.fecha.split("-").slice(0,2);
    const k = `${mes}-${anio}`;
    if(!meses[k]) meses[k] = { ingresos:0, gastos:0 };
    if(m.tipo === "ingreso") meses[k].ingresos += m.importe;
    else meses[k].gastos += m.importe;
  });

  const keysMeses = Object.keys(meses).sort((a,b)=>{
    const [ma,aa] = a.split("-"), [mb,ab] = b.split("-");
    return new Date(`${aa}-${ma}-01`) - new Date(`${ab}-${mb}-01`);
  });

  chart3 = new Chart(ctx3, {
    type: "bar",
    data: {
      labels: keysMeses,
      datasets: [
        { label: "Ingresos", data: keysMeses.map(k=>meses[k].ingresos), backgroundColor: "#4caf50" },
        { label: "Gastos", data: keysMeses.map(k=>meses[k].gastos), backgroundColor: "#f44336" }
      ]
    },
    options: { responsive:true, maintainAspectRatio:false }
  });
}

/* ===============================
   Orden toggle en cabecera Fecha
   =============================== */
function toggleOrden(){
  ordenAsc = !ordenAsc;
  renderMovimientos();
}

/* ===============================
   Inicializaci√≥n
   =============================== */
document.addEventListener("DOMContentLoaded", ()=>{
  abrirBD();
  // ajustar visibilidad del header categoria al cargar
  toggleCategoria();
  // Si el viewport es ancho, mostrar resumen (ya aparece)
  // No hacemos borrado de datos: persistent DB mantiene lo existente.
});
</script>
</body>
</html>
