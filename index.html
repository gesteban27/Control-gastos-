<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Control de Gastos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="theme-color" content="#ffffff">
  <style>
    :root{
      --accent: #1976d2;
      --bg: #ffffff;
      --card: #ffffff;
      --muted: #71777f;
      --verde: #2e944b;
      --rojo: #d32f2f;
      --radius: 12px;
      --border: #e8e9eb;
      --control-bg: #fbfbfb;
      --btn-border: #d0d3d7;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color:#222;
      display:flex;
      justify-content:center;
      padding:1rem;
      min-height:100vh;
    }

    .app{
      width:100%;
      max-width:980px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 8px 20px rgba(10,20,30,0.04);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 70vh;
    }

    header{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
      color:#111;
      padding:14px 18px;
      border-bottom: 1px solid var(--border);
    }
    header h1{ margin:0; font-size:1.15rem; text-align:center; font-weight:600; }

    /* Layout: left column (home) + right column (panels) */
    main{ display:grid; grid-template-columns: 1fr 360px; gap:18px; padding:18px; }
    @media(max-width:900px){ main{ grid-template-columns: 1fr; padding:14px; } }

    .left { display:flex; flex-direction:column; gap:12px; }

    .card {
      background:var(--card);
      border-radius:10px;
      padding:10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.03);
      border: 1px solid var(--border);
    }

    .form-table, .mov-table { width:100%; border-collapse:collapse; }
    .form-table th, .form-table td, .mov-table th, .mov-table td {
      padding:8px; text-align:center; border-bottom:1px solid var(--border); font-size:0.95rem;
    }
    .form-table thead th, .mov-table thead th { background: var(--control-bg); font-weight:700; color:#444; }

    .form-row input, .form-row select {
      width:100%; padding:8px; border-radius:8px; border:1px solid var(--btn-border); font-size:0.95rem; background: #fff;
    }

    /* botones discretos (sin azul) */
    .btn { background:transparent; color:#222; border:1px solid var(--btn-border); padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700; }
    .btn:active{ transform:translateY(1px); }

    .mov-table thead th[role="sortable"]{ cursor:pointer; user-select:none; }

    tr.ingreso { background: rgba(46,148,75,0.04); }
    tr.gasto   { background: rgba(211,47,47,0.04); }

    .importe-col { text-align:right; font-weight:700; }
    .importe-ingreso { color: var(--verde); }
    .importe-gasto { color: var(--rojo); }

    .action-col { width:56px; }

    /* Right column (panels) */
    .right { display:flex; flex-direction:column; gap:12px; }
    .chart-card { background:var(--card); padding:10px; border-radius:10px; box-shadow: 0 1px 4px rgba(0,0,0,0.02); border:1px solid var(--border); }

    .charts-row { display:flex; gap:12px; flex-direction:column; }
    @media(min-width:900px){
      .charts-row { flex-direction:row; }
      .charts-row .chart-card { flex:1; }
    }

    canvas{ width:100% !important; height:240px !important; border-radius:8px !important; display:block; }

    .bottom-nav {
      display:flex; gap:6px; justify-content:space-around; padding:10px; border-top:1px solid var(--border); background:var(--card);
      position: sticky; bottom: 0;
    }
    .tab-btn { background:none; border:none; cursor:pointer; padding:8px 10px; font-weight:700; color:#444; display:flex; flex-direction:column; align-items:center; gap:4px; }
    .tab-btn.active{ color:var(--accent); }

    .muted{ color:var(--muted); font-size:0.9rem; }
    .small-input{ max-width:220px; padding:8px; border-radius:8px; border:1px solid var(--btn-border); background:#fff; }

    /* hide right column visually when home active to ensure "only formulario + tabla" */
    .right.hidden { display:none; }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Control de Gastos">
    <header><h1>Control de Gastos</h1></header>

    <main>
      <!-- LEFT: formulario + tabla (home) -->
      <section class="left" id="homeColumn">
        <div class="card" aria-labelledby="form-title">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div><strong id="form-title">Añadir movimiento</strong></div>
            <div class="muted">Rellena fecha y importe</div>
          </div>

          <table class="form-table" role="form" aria-label="Formulario de movimiento">
            <thead>
              <tr>
                <th>Fecha</th><th>Tipo</th><th id="categoriaHeader">Categoría</th><th>Importe</th><th>Acción</th>
              </tr>
            </thead>
            <tbody>
              <tr class="form-row">
                <td><input id="fecha" type="date" /></td>
                <td>
                  <select id="tipo" onchange="toggleCategoria()">
                    <option value="ingreso">Ingreso</option>
                    <option value="gasto">Gasto</option>
                  </select>
                </td>
                <td id="categoriaCell">
                  <select id="categoria">
                    <option>Casa</option>
                    <option>Alimentación</option>
                    <option>Ocio</option>
                    <option>Impuestos</option>
                  </select>
                </td>
                <td><input id="importe" type="number" step="0.01" /></td>
                <td><button class="btn" onclick="agregarMovimiento()">➕ Añadir</button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="card" aria-labelledby="mov-list-title" style="padding-bottom:6px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div><strong id="mov-list-title">Movimientos</strong></div>
            <div class="muted">Ordena por fecha: haz clic en la cabecera</div>
          </div>

          <table class="mov-table" id="tablaMovimientos" aria-label="Tabla de movimientos">
            <thead>
              <tr>
                <th role="sortable" onclick="toggleOrden()">Fecha ⬍</th>
                <th>Tipo</th>
                <th>Categoría</th>
                <th>Importe</th>
                <th class="action-col">Acción</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- RIGHT: panels (hidden when home active) -->
      <aside class="right hidden" id="rightColumn">
        <!-- GRÁFICOS -->
        <div id="graficosPanel" style="display:none;">
          <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px;">
            <div style="display:flex; gap:8px; align-items:center;">
              <label class="muted">Mes</label>
              <input id="grafMes" type="month" class="small-input" />
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <label class="muted">Tipo</label>
              <select id="grafTipo" class="small-input">
                <option value="todos">Todos</option>
                <option value="ingreso">Ingresos</option>
                <option value="gasto">Gastos</option>
              </select>
            </div>
          </div>

          <div class="charts-row">
            <div class="chart-card">
              <h4 style="margin:6px 0;">Distribución por categoría</h4>
              <canvas id="grafCat"></canvas>
            </div>
            <div class="chart-card">
              <h4 style="margin:6px 0;">Ingresos vs Gastos (mes)</h4>
              <canvas id="grafBar"></canvas>
            </div>
          </div>
        </div>

        <!-- RESUMEN -->
        <div id="resumenPanel" style="display:none;">
          <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px;">
            <div style="display:flex; gap:8px; align-items:center;">
              <label class="muted">Mes</label>
              <input id="resMes" type="month" class="small-input" />
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
            <div class="card" style="min-width:140px; text-align:center;">
              <div class="muted">Ingresos</div>
              <div id="res_ing" style="font-weight:800; margin-top:6px;">0.00 €</div>
            </div>
            <div class="card" style="min-width:140px; text-align:center;">
              <div class="muted">Gastos</div>
              <div id="res_gas" style="font-weight:800; margin-top:6px;">0.00 €</div>
            </div>
            <div class="card" style="min-width:140px; text-align:center;">
              <div class="muted">Saldo</div>
              <div id="res_saldo" style="font-weight:800; margin-top:6px;">0.00 €</div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <div class="charts-row">
              <div class="chart-card" style="flex:1;">
                <h4 style="margin:6px 0;">Gastos por categoría</h4>
                <canvas id="resDough"></canvas>
              </div>
              <div class="chart-card" style="flex:1;">
                <h4 style="margin:6px 0;">Ingresos vs Gastos (mes)</h4>
                <canvas id="resBar"></canvas>
              </div>
            </div>
          </div>
        </div>

      </aside>
    </main>

    <!-- bottom navigation (single control for panels) -->
    <nav class="bottom-nav" role="navigation" aria-label="Navegación app">
      <button id="nav-home" class="tab-btn active" onclick="showTab('home')">🏠<small>Inicio</small></button>
      <button id="nav-graphs" class="tab-btn" onclick="showTab('graficos')">📊<small>Gráficos</small></button>
      <button id="nav-summary" class="tab-btn" onclick="showTab('resumen')">📅<small>Resumen</small></button>
    </nav>
  </div>

<script>
/* ===== IndexedDB ===== */
let db;
let movimientos = [];
let ordenAsc = false;

function abrirDB(){
  const req = indexedDB.open('GastosDB_v3', 1);
  req.onupgradeneeded = e => {
    db = e.target.result;
    if(!db.objectStoreNames.contains('movs')){
      const store = db.createObjectStore('movs', { keyPath: 'id', autoIncrement: true });
      store.createIndex('fecha','fecha',{unique:false});
    }
  };
  req.onsuccess = e => {
    db = e.target.result;
    cargarTodos();
  };
  req.onerror = e => {
    console.error('IndexedDB error', e);
    alert('Error accediendo al almacenamiento local.');
  };
}

function añadirDB(obj){
  const tx = db.transaction('movs','readwrite');
  tx.objectStore('movs').add(obj);
  tx.oncomplete = () => cargarTodos();
  tx.onerror = e => console.error('add err', e);
}

function borrarDB(id){
  const tx = db.transaction('movs','readwrite');
  tx.objectStore('movs').delete(Number(id));
  tx.oncomplete = () => cargarTodos();
  tx.onerror = e => console.error('del err', e);
}

function cargarTodos(){
  const tx = db.transaction('movs','readonly');
  const req = tx.objectStore('movs').getAll();
  req.onsuccess = () => {
    movimientos = req.result || [];
    movimientos.sort((a,b)=> new Date(a.fecha) - new Date(b.fecha));
    renderTable();
    // if panels visible, regenerate charts/summary
    if(isPanelVisible('graficos')) generarGraficos();
    if(isPanelVisible('resumen')) generarResumen();
  };
  req.onerror = e => console.error('getAll err', e);
}

/* ===== UI / form logic ===== */
function toggleCategoria(){
  const tipo = document.getElementById('tipo').value;
  const catCell = document.getElementById('categoriaCell');
  const catHeader = document.getElementById('categoriaHeader');
  if(tipo === 'ingreso'){ catCell.style.display = 'none'; catHeader.style.display='none'; }
  else { catCell.style.display = 'table-cell'; catHeader.style.display='table-cell'; }
}

function agregarMovimiento(){
  const fecha = document.getElementById('fecha').value;
  const tipo = document.getElementById('tipo').value;
  const categoria = tipo === 'gasto' ? document.getElementById('categoria').value : '';
  const importeRaw = document.getElementById('importe').value;
  const importe = parseFloat(importeRaw);
  if(!fecha || !importeRaw || isNaN(importe)) return alert('Completa fecha y un importe válido.');
  añadirDB({ fecha, tipo, categoria, importe });
  document.getElementById('importe').value = '';
}

/* ===== Table rendering ===== */
const tbody = document.querySelector('#tablaMovimientos tbody');

function renderTable(){
  tbody.innerHTML = '';
  const copia = [...movimientos].sort((a,b)=>{
    const da = new Date(a.fecha), db = new Date(b.fecha);
    return ordenAsc ? da - db : db - da;
  });
  copia.forEach(m=>{
    const tr = document.createElement('tr');
    tr.classList.add(m.tipo === 'ingreso' ? 'ingreso' : 'gasto');
    const fechaDisplay = m.fecha.split('-').reverse().join('-'); // dd-mm-aaaa
    const impClass = m.tipo === 'ingreso' ? 'importe-ingreso' : 'importe-gasto';
    tr.innerHTML = `
      <td>${fechaDisplay}</td>
      <td>${m.tipo}</td>
      <td>${m.categoria || ''}</td>
      <td class="importe-col ${impClass}">${m.tipo==='ingreso'?'+':'-'}${m.importe.toFixed(2)} €</td>
      <td class="action-col"><button class="btn" onclick="confirmBorrar(${m.id})">❌</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function confirmBorrar(id){
  if(confirm('¿Eliminar este movimiento?')) borrarDB(id);
}

/* ===== Tabs / panels control ===== */
function clearActiveNav(){ document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); }
function hidePanels(){
  document.getElementById('graficosPanel').style.display = 'none';
  document.getElementById('resumenPanel').style.display = 'none';
}
function isPanelVisible(panel){
  if(panel === 'graficos') return document.getElementById('graficosPanel').style.display === 'block';
  if(panel === 'resumen') return document.getElementById('resumenPanel').style.display === 'block';
  return false;
}
function showTab(tab){
  clearActiveNav();
  hidePanels();
  // hide right column by default; show only when panel requested
  const rightCol = document.getElementById('rightColumn');
  rightCol.classList.add('hidden');

  if(tab === 'home'){
    document.getElementById('nav-home').classList.add('active');
    // home shows left column only (right hidden)
  } else if(tab === 'graficos'){
    document.getElementById('nav-graphs').classList.add('active');
    document.getElementById('graficosPanel').style.display = 'block';
    rightCol.classList.remove('hidden');
    if(!document.getElementById('grafMes').value) document.getElementById('grafMes').value = obtenerMesActual();
    generarGraficos();
    // ensure listeners fire
  } else if(tab === 'resumen'){
    document.getElementById('nav-summary').classList.add('active');
    document.getElementById('resumenPanel').style.display = 'block';
    rightCol.classList.remove('hidden');
    if(!document.getElementById('resMes').value) document.getElementById('resMes').value = obtenerMesActual();
    generarResumen();
  }
  // scroll to top
  document.querySelector('.app').scrollIntoView({behavior:'smooth'});
}

/* ===== Charts ===== */
let chartCat, chartBar, resDough, resBar;

function generarGraficos(){
  const month = document.getElementById('grafMes').value;
  const tipo = document.getElementById('grafTipo').value;
  let fil = [...movimientos];
  if(month) fil = fil.filter(m=> m.fecha.startsWith(month));
  if(tipo !== 'todos') fil = fil.filter(m=> m.tipo === tipo);

  const porCat = {};
  fil.filter(m=> m.tipo === 'gasto').forEach(m => porCat[m.categoria] = (porCat[m.categoria] || 0) + m.importe);

  const totalIngresos = fil.filter(m=> m.tipo === 'ingreso').reduce((s,m)=> s + m.importe, 0);
  const totalGastos = fil.filter(m=> m.tipo === 'gasto').reduce((s,m)=> s + m.importe, 0);

  const ctxCat = document.getElementById('grafCat').getContext('2d');
  const ctxBar = document.getElementById('grafBar').getContext('2d');

  if(chartCat) chartCat.destroy();
  chartCat = new Chart(ctxCat, {
    type: 'doughnut',
    data: { labels: Object.keys(porCat), datasets: [{ data: Object.values(porCat), backgroundColor: ["#f44336","#ff9800","#2196f3","#9c27b0","#4caf50"] }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
  });

  if(chartBar) chartBar.destroy();
  chartBar = new Chart(ctxBar, {
    type: 'bar',
    data: {
      labels: ['Seleccionado'],
      datasets: [
        { label:'Ingresos', data:[totalIngresos], backgroundColor:'#4caf50' },
        { label:'Gastos', data:[totalGastos], backgroundColor:'#f44336' }
      ]
    },
    options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
  });
}

/* ===== Resumen ===== */
function generarResumen(){
  const month = document.getElementById('resMes').value || obtenerMesActual();
  const movMes = movimientos.filter(m => m.fecha.startsWith(month));
  const ingresos = movMes.filter(m=> m.tipo==='ingreso').reduce((s,m)=> s + m.importe, 0);
  const gastos = movMes.filter(m=> m.tipo==='gasto').reduce((s,m)=> s + m.importe, 0);
  const balance = ingresos - gastos;

  document.getElementById('res_ing').textContent = ingresos.toFixed(2) + ' €';
  document.getElementById('res_gas').textContent = gastos.toFixed(2) + ' €';
  const elResSaldo = document.getElementById('res_saldo');
  elResSaldo.textContent = balance.toFixed(2) + ' €';
  elResSaldo.style.color = balance>0 ? 'var(--verde)' : balance<0 ? 'var(--rojo)' : '#222';

  const porCat = {};
  movMes.filter(m => m.tipo==='gasto').forEach(m => porCat[m.categoria] = (porCat[m.categoria] || 0) + m.importe);

  const ctxD = document.getElementById('resDough').getContext('2d');
  const ctxB = document.getElementById('resBar').getContext('2d');

  if(resDough) resDough.destroy();
  resDough = new Chart(ctxD, {
    type:'doughnut',
    data:{ labels:Object.keys(porCat), datasets:[{ data:Object.values(porCat), backgroundColor:["#f44336","#ff9800","#2196f3","#9c27b0","#4caf50"] }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
  });

  if(resBar) resBar.destroy();
  resBar = new Chart(ctxB, {
    type:'bar',
    data:{ labels:[obtenerNombreMes(new Date(month+'-01').getMonth()) + ' ' + new Date(month+'-01').getFullYear()], datasets:[
      { label:'Ingresos', data:[ingresos], backgroundColor:'#4caf50' },
      { label:'Gastos', data:[gastos], backgroundColor:'#f44336' }
    ] },
    options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
  });
}

/* ===== Helpers ===== */
function obtenerMesActual(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  return `${y}-${m}`;
}
function obtenerNombreMes(idx){
  const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  return meses[idx] || '';
}

/* ===== Orden toggle ===== */
function toggleOrden(){ ordenAsc = !ordenAsc; renderTable(); }

/* ===== Init ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  abrirDB();
  toggleCategoria();
  // set default month pickers
  document.getElementById('grafMes').value = obtenerMesActual();
  document.getElementById('resMes').value = obtenerMesActual();
  showTab('home');

  // regenerate charts on change
  document.getElementById('grafMes').addEventListener('change', generarGraficos);
  document.getElementById('grafTipo').addEventListener('change', generarGraficos);
  document.getElementById('resMes').addEventListener('change', generarResumen);
});
</script>
</body>
</html>
